<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <script type="text/javascript" src="lib/jquery.min.js"></script>
    <script type="text/javascript" src="lib/osql.js"></script>
    <link rel="stylesheet" href="./baloon.css">

    <script>
        osql.requireLogin();

        var me;
        var roomId = osql.getParam('roomId');

        $(document).ready(async function () {
            try {
                me = await osql.getMe();
                document.getElementById('firstname').innerHTML = me.fname;
                document.getElementById('lastname').innerHTML = me.lname;

                var sql = `select * from Rooms where id = ${roomId};`;
                var objects = await osql.connect(sql);

                var room = objects[0];
                document.getElementById('roomname').innerHTML = room.name;

                await refreshComments();
                setInterval(refreshComments, 2000);
            } catch (error) {
                console.error('Error in document ready:', error);
            }
        });

        async function newComment() {
            try {
                var commentText = document.getElementById('bms_send_message').value;
                if (commentText.trim() === '') return; // 空のコメントを無視

                var sql = `insert into Comments (roomId, userId, comment, time) values(${roomId}, '${me.id}', '${commentText}', now());`;
                var commentId = await osql.connectInsert(sql);
                console.log('Comment ID:', commentId);

                document.getElementById('bms_send_message').value = ''; // 入力フィールドをクリア

                await refreshComments();
            } catch (error) {
                console.error('Error in newComment:', error);
            }
        }

        async function refreshComments() {
            try {
                var sql = `select * from Comments where roomId = ${roomId} order by time desc limit 10;`;
                var objects = await osql.connect(sql);
                console.log('Comments:', objects);
                var html = '';
                for (var i = 0; i < objects.length; i++) {
                    var object = objects[i];
                    var alignment = object.userId === me.id ? 'bms_right' : 'bms_left';
                    html += `
                        <div class="bms_message ${alignment}">
                            <div class="bms_message_box">
                                <div class="bms_message_content">
                                    <div class="bms_message_text">${object.comment}</div>
                                    <div class="bms_message_time">${object.time}</div>
                                </div>
                            </div>
                        </div>
                        <div class="bms_clear"></div>`;
                }
                document.getElementById('bms_messages').innerHTML = html;
            } catch (error) {
                console.error('Error in refreshComments:', error);
            }
        }
    </script>

    <style>
        .bms_message {
            margin: 10px 0;
        }
        .bms_left .bms_message_box {
            background-color: #f1f1f1;
            text-align: left;
        }
        .bms_right .bms_message_box {
            background-color: #d1e7dd;
            text-align: right;
            float: right;
        }
        .bms_message_content {
            padding: 10px;
            border-radius: 10px;
            max-width: 60%;
            display: inline-block;
        }
        .bms_message_text {
            margin-top: 5px;
        }
        .bms_message_time {
            font-size: 0.8em;
            color: #888;
        }
        .bms_clear {
            clear: both;
        }
        #bms_messages {
            overflow-y: auto;
            height: 400px;
        }
    </style>
</head>

<body>
    <h1>talkroom <span id="roomname"></span></h1>
    <div style="text-align: right;">
        ようこそ<span id="lastname"></span> <span id="firstname"></span>さん
        <a href="index.html">top</a>
    </div>
    <hr>
    <div id="your_container">
        <div id="bms_messages_container">
            <div id="bms_chat_header">
                <div id="bms_chat_user_status">
                    <div id="bms_status_icon">●</div>
                    <div id="bms_chat_user_name">ユーザー</div>
                </div>
            </div>
            <div id="bms_messages"></div>
            <div id="bms_send">
                <textarea id="bms_send_message"></textarea>
                <div id="bms_send_btn" onclick="newComment()">送信</div>
            </div>
        </div>
    </div>
</body>
</html>
